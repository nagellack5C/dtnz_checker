<html>

<style type="text/css" media="screen">

.textAreaColumn{
    width:100%;
}
.textAreaColumn div{
    float:left;
    width:50%;
    padding:10px;
    box-sizing: border-box;
}

.textAreaColumn div span{
    display:block;
    text-align:center;
}

.textAreaColumn div div{
    overflow-y: scroll;
    box-sizing: border-box;
    width:100%;
    /* border:3px solid red; */
    height:80%;
}

.textAreaColumn div textarea{
    box-sizing: border-box;
    width:100%;
    border:3px solid red;
    height:80%;
}

mark {
  cursor: pointer;
}

</style>

<body>
  <div align="center">
    <select onChange="fetch_new(this.value)" id="analyst">
      <option value="none">None</option>
      <option value="nrusin">Nikita</option>
      <option value="rnabiullin">Rustem</option>
      <option value="safy">Safy</option>
      <option value="aklimov">AlexK</option>
    </select>
    <div id="stats"></div>
    <div class="textAreaColumn" align="center">
        <div>
            <span>Job Description</span>
            <div id="job_text" align="justify"></div>
        </div>
        <div>
            <span>Techs Found</span>
            <textarea id="found_techs"></textarea>
            <button id="comeback">Come Back</button>
            <button id="save">Save</button>
        </div>
    </div>
  </div>
</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>

<script type="text/javascript">



  console.log("cookies: " + document.cookie);

  job_textarea = document.getElementById("job_text")
  techs_textarea = document.getElementById("found_techs")
  save_btn = document.getElementById("save")
  comeback_btn = document.getElementById("comeback")
  analyst = document.getElementById("analyst")
  db_url = "https://api.mlab.com/api/1/databases/job_dtnz/collections/job_descriptions"
  token = "apiKey=LQvZpFAypOqcF4Wwt8juHIHMCtjNgXDo"
  current_id = ""
  prev_id = ""

  x = document.cookie;
  if (x.length > 0){
    analyst.value = x.split("=")[1];
  }

  save_btn.addEventListener("click", save)
  comeback_btn.addEventListener("click", fetch_by_id)

  function fetch_new(name){
    document.cookie = "username=" + analyst.value;
    // console.log(current_id, prev_id)
    if (analyst.value == "none"){
      job_textarea.value = "Select your name from the list!"
    } else {
        console.log("fetching...")
        prev_id = current_id
        fetch(
        db_url + '?q={"name": "' + name + '", "done": "no"}' + "&" + token)
        .then(function(resp){
          return (resp.json())
        })
        .then(function(json){
          process_text(json[0].job_id + "\n" + json[0].job_desc);
          found_techs.value = json[0].techs;
          current_id = json[0]._id.$oid;
      })
    }
  }

  function fetch_by_id(){
    // console.log(prev_id, current_id)
    fetch(
    db_url + "/" + prev_id + "?" + token)
    .then(function(resp){
      return (resp.json())
    })
    .then(function(json){
      // console.log(json)
      process_text(json.job_id + "\n" + json.job_desc)
      found_techs.value = json.techs
      current_id = json._id.$oid
  })
  }

  function save(){
    if (analyst.value != "none"){
      fetch(
        db_url + "/" + current_id + "?" + token,
        {method: "PUT",
        headers: {
          "Content-Type": "application/json; charset=utf-8"
        },
        body: JSON.stringify( { "$set" : { "techs" : techs_textarea.value, "done": "yes" } } ) }
      ).then(function(resp){
        // console.log(resp)
      }).then(function(){
        fetch_new(analyst.value)
        analysts[analyst.value] += 1
        update_stats();
      })
    } else {
      job_textarea.value = "Select your name from the list!"
    }
  }

  function process_text(text){
    var txttostore = '<p>' + text.replace(/\n/g, "</p>\n<p>") + '</p>';
    // txttostore = txttostore.replace(/(([ ]?[A-Z][A-Za-z0-9+-]*){1,})/gm, "<span class='highlight'>$&</span>")
    job_textarea.innerHTML = txttostore;
    highlight_text();
    marked = document.getElementsByTagName("mark");
    [].forEach.call(marked, function(marked_el){
      marked_el.addEventListener("click", function(event){
        // console.log(event.target.innerHTML)
        if (found_techs.value == "" || found_techs.value == "none"){
          found_techs.value = event.target.innerHTML.trim();
        } else {
          found_techs.value += ", " + event.target.innerHTML.trim();
        }
        event.target.style.backgroundColor = "orange";
      })
    })
  }

  function highlight_text(){
    var instance = new Mark(job_textarea);
    instance.markRegExp(/(([ ]?[A-Z][A-Za-z0-9+-]*){1,})/gm)
  }

  analysts = {
    "nrusin": 0,
    "rnabiullin": 0,
    "safy": 0,
    "aklimov": 0
  }

  const get_counts = async() => {
    // console.log(db_url + '?q={"done": "yes"}' + "&" + token);
    const response = await fetch(db_url + '?q={"done": "yes"}' + "&" + token);
    const json = await response.json();

    for (var i in json){
      analysts[json[i].name] += 1
    }
    update_stats();
  }

  function update_stats(){
    document.getElementById("stats").innerHTML = ""
    Object.keys(analysts).forEach(function(name){
      document.getElementById("stats").innerHTML = document.getElementById("stats").innerHTML + name + ": " + analysts[name] + " "
    })
  }

  if (analyst.value != "None"){
    fetch_new(analyst.value);
  }

  get_counts();

  // fetch_new("aklimov")


</script>

</html>
